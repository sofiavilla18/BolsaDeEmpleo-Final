# ASP.NET Core
# Build and test ASP.NET Core projects targeting .NET Core.
# Add steps that run tests, create a NuGet package, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/dotnet-core

# ASP.NET Core Pipeline - Build + Test paralelos

# ASP.NET Core
# Build and test ASP.NET Core projects targeting .NET Core.
# Add steps that run tests, create a NuGet package, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/dotnet-core

trigger:
- master

pool:
  vmImage: 'windows-latest'

# Paso 1: Compilación con un solo agente
jobs:
- job: Build
  displayName: 'Build job (single agent)'
  steps:
  - task: UseDotNet@2
    inputs:
      packageType: 'sdk'
      version: '8.0.x'

  # Ejecutar pruebas específicas antes de publicar
  - script: dotnet test mst_pruebas/mst_pruebas.csproj --filter "Name=Guardar"
    displayName: 'Run specific test: Guardar'

  # Publicar los artefactos de compilación
  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)'
      ArtifactName: 'drop'

# Paso 2: Ejecución de pruebas en paralelo
- job: Test
  displayName: 'Run tests in parallel'
  dependsOn: Build  # Espera que termine el job anterior
  pool:
    vmImage: 'windows-latest'
  strategy:
    parallel: 2  # Ejecuta los tests en 2 agentes en paralelo
  steps:
  - task: DownloadBuildArtifacts@1
    inputs:
      buildType: 'current'
      downloadType: 'single'
      artifactName: 'drop'
      downloadPath: '$(System.DefaultWorkingDirectory)'

  # Ejecución de todas las pruebas con tolerancia a fallos
  - task: VSTest@2
    continueOnError: true
    inputs:
      testSelector: 'testAssemblies'
      testAssemblyVer2: |
        **\mst_pruebas.dll
      searchFolder: '$(System.DefaultWorkingDirectory)\drop'
      runInParallel: true
      codeCoverageEnabled: true



